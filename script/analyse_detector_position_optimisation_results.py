#!/usr/bin/env python3

import helper_functions
import matplotlib.pyplot as plt
import os
import subprocess
import numpy as np
import json
import argparse

def get_args():
    parser = argparse.ArgumentParser(description='Analyse the results of detector position refinement and display results.')
    parser.add_argument('input_folder', help='folder containing parameters.json file generated by optimise_geometry_by_indexing_rate.py with processing parameters.')
    return parser.parse_args()

def display_2d_results(data, n_a:int, n_b:int, i_a:float, i_b:float, ax1lab:str, ax2lab:str):
    """ Display results as a pixel-plot with a colorramp corresponding to the number of indexed images
    at each position.
    """
    a_extent = i_a*float(n_a)/2
    b_extent = i_b*float(n_b)/2
    aticks, bticks, cticks = helper_functions.calculate_points(n_a, n_b, 0, i_a, i_b, 0)
    pixel_plot = plt.figure()
    plt.title('indexing results by detector origin translation')
    plt.xlabel(ax1lab)
    plt.ylabel(ax2lab)
    pixel_plot = plt.imshow(data,extent=[-a_extent, a_extent, -b_extent, b_extent])
    plt.xticks(aticks)
    plt.yticks(bticks)
    cbar = plt.colorbar(pixel_plot)
    cbar.ax.set_ylabel('# of indexed images')
    plt.show()

def display_1d_results(data, n_a:int, i_a:float, ax1lab:str):
    """ Display results as a bar graph
    """
    a_extent = i_a*float(n_a)/2
    aticks, bticks, cticks = helper_functions.calculate_points(n_a, 0, 0, i_a, 0, 0)
    bar_plot = plt.figure()
    plt.title('indexing results by detector origin translation')
    plt.xlabel(ax1lab)
    plt.ylabel('# of indexed images')
    print(aticks)
    print(data)
    bar_plot = plt.bar(aticks,data,width=i_a,linewidth=1,edgecolor='k')
    plt.xticks(aticks)
    plt.show()


def load_results_from_folders(dims):
    """ In the absence of a file with proper parameters, attempt to look at the output folders.
    """
    outfolders = [x for x in os.listdir('..') if x.endswith('out')]
    images_indexed = []
    for f in outfolders:
        print(f)
        imgs = subprocess.run(['grep real_space_a ../'+f+'/*refined.expt | wc -l'],shell=True,capture_output=True)
        print(int(imgs.stdout.decode()))
        images_indexed.append(int(imgs.stdout.decode()))

    grid = np.reshape(images_indexed, dims, order='F')
    names = np.reshape(outfolders, dims, order='F')

    return grid

def load_results_from_list(names):
    """ When running directly after a completed run, use the info we already have
    """
    outfolders = [x for x in os.listdir('..') if x.endswith('out')]
    images_indexed = []
    for f in outfolders:
        print(f)
        imgs = subprocess.run(['grep real_space_a ../'+f+'/*refined.expt | wc -l'],shell=True,capture_output=True)
        print(int(imgs.stdout.decode()))
        images_indexed.append(int(imgs.stdout.decode()))

    grid = np.reshape(images_indexed, dims, order='F')
    names = np.reshape(outfolders, dims, order='F')

    return grid

def main():
    args = get_args()
    foldername = args.input_folder
    os.chdir(foldername)
    with open('parameters.json') as f:
        parameters = json.load(f)
    
    dims = (parameters['n_x'],parameters['n_y'],parameters['n_d'])
    incrs = (parameters['i_x'],parameters['i_y'],parameters['i_d'])
    data = np.squeeze(load_results_from_folders(dims))

    if dims[2] == 1:
        display_2d_results(data, dims[0], dims[1], incrs[0], incrs[1], 'x increment from original geometry (mm)', 'y increment from original geometry (mm)')
    elif dims[0] == 1 and dims[1] == 1:
        display_1d_results(data, dims[2], incrs[2], 'distance increment from original geometry (mm)')
    else:
        logging.error('Sorry, only analysis of x & y or distance is supported currently, 3d analysis not yet possible.')


if __name__ == '__main__':
    import logging
    logging.basicConfig(filename='log.txt',level=logging.DEBUG)
    logging.getLogger().addHandler(logging.StreamHandler())
    main()